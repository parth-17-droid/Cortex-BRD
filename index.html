<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cortex BRD — Business Requirements Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #f8f9fa;
  --surface:   #ffffff;
  --surface2:  #f1f3f5;
  --border:    #e5e7eb;
  --border2:   #d1d5db;
  --text:      #111827;
  --text-2:    #374151;
  --text-3:    #6b7280;
  --text-4:    #9ca3af;
  --accent:    #2563eb;
  --accent-bg: #eff6ff;
  --accent-bd: #bfdbfe;
  --green:     #16a34a;
  --green-bg:  #f0fdf4;
  --green-bd:  #bbf7d0;
  --amber:     #d97706;
  --amber-bg:  #fffbeb;
  --amber-bd:  #fde68a;
  --red:       #dc2626;
  --red-bg:    #fef2f2;
  --red-bd:    #fecaca;
  --purple:    #7c3aed;
  --purple-bg: #f5f3ff;
  --purple-bd: #ddd6fe;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow:    0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.07), 0 4px 6px rgba(0,0,0,0.04);
  --radius:    8px;
  --radius-sm: 5px;
  --radius-lg: 12px;
}

html, body {
  height: 100%;
  font-family: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ── Layout ─────────────────────────────────────────────────────────── */
.app { display: flex; height: 100vh; overflow: hidden; }

/* ── Sidebar ────────────────────────────────────────────────────────── */
.sidebar {
  width: 240px;
  flex-shrink: 0;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-logo {
  height: 56px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
}

.logo-mark {
  width: 28px;
  height: 28px;
  background: var(--accent);
  border-radius: 7px;
  display: grid;
  place-items: center;
}

.logo-mark svg { color: white; }

.logo-name {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: -0.3px;
  color: var(--text);
}

.logo-badge {
  margin-left: auto;
  font-size: 10px;
  font-weight: 500;
  background: var(--accent-bg);
  color: var(--accent);
  border: 1px solid var(--accent-bd);
  padding: 2px 6px;
  border-radius: 99px;
}

.sidebar-section {
  padding: 8px 8px 4px;
}

.sidebar-label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-4);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  padding: 4px 8px 6px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.12s;
  color: var(--text-3);
  font-weight: 400;
  font-size: 13.5px;
  user-select: none;
}

.nav-item:hover { background: var(--bg); color: var(--text-2); }
.nav-item.active { background: var(--accent-bg); color: var(--accent); font-weight: 500; }
.nav-item svg { flex-shrink: 0; opacity: 0.7; }
.nav-item.active svg { opacity: 1; }

.nav-item .count {
  margin-left: auto;
  font-size: 11px;
  background: var(--surface2);
  color: var(--text-3);
  padding: 1px 6px;
  border-radius: 99px;
  min-width: 18px;
  text-align: center;
}

.nav-item.active .count {
  background: var(--accent-bd);
  color: var(--accent);
}

.sidebar-projects {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.sidebar-projects::-webkit-scrollbar { width: 3px; }
.sidebar-projects::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.project-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.12s;
  color: var(--text-3);
  font-size: 13px;
}

.project-item:hover { background: var(--bg); color: var(--text-2); }
.project-item.active { background: var(--accent-bg); color: var(--accent); font-weight: 500; }

.project-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: currentColor;
  opacity: 0.5;
  flex-shrink: 0;
}

.project-item.active .project-dot { opacity: 1; }

.sidebar-footer {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--text-4);
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 5px;
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #22c55e;
}

/* ── Main ───────────────────────────────────────────────────────────── */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* ── Topbar ─────────────────────────────────────────────────────────── */
.topbar {
  height: 56px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 12px;
  flex-shrink: 0;
}

.topbar-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: -0.2px;
}

.topbar-sep { color: var(--text-4); }

.topbar-sub {
  font-size: 13px;
  color: var(--text-3);
}

.topbar-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; }

/* ── Buttons ────────────────────────────────────────────────────────── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.12s;
  font-family: inherit;
  line-height: 1;
  white-space: nowrap;
}

.btn-primary {
  background: var(--accent);
  color: white;
  box-shadow: var(--shadow-sm);
}
.btn-primary:hover { background: #1d4ed8; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: var(--surface);
  color: var(--text-2);
  border: 1px solid var(--border2);
  box-shadow: var(--shadow-sm);
}
.btn-secondary:hover { background: var(--bg); border-color: var(--text-4); }

.btn-ghost {
  background: transparent;
  color: var(--text-3);
  padding: 6px 10px;
}
.btn-ghost:hover { background: var(--bg); color: var(--text-2); }

.btn-sm { padding: 5px 10px; font-size: 12px; }

/* ── Content ────────────────────────────────────────────────────────── */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.content::-webkit-scrollbar { width: 6px; }
.content::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* ── Pages ──────────────────────────────────────────────────────────── */
.page { display: none; }
.page.active { display: block; }

/* ── Dashboard ──────────────────────────────────────────────────────── */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 20px;
  box-shadow: var(--shadow-sm);
}

.stat-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-3);
  letter-spacing: 0.2px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -1px;
  line-height: 1;
  margin-bottom: 6px;
}

.stat-change {
  font-size: 12px;
  color: var(--text-4);
}

.stat-icon {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  display: grid;
  place-items: center;
  margin-bottom: 12px;
}

/* ── Cards ──────────────────────────────────────────────────────────── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.card-header {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.card-title {
  font-size: 13.5px;
  font-weight: 600;
  color: var(--text);
}

.card-body { padding: 20px; }

/* ── Tabs ───────────────────────────────────────────────────────────── */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  padding: 0 24px;
  flex-shrink: 0;
}

.tab-btn {
  padding: 13px 16px 11px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.12s;
  white-space: nowrap;
  user-select: none;
}

.tab-btn:hover { color: var(--text-2); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ── Form ───────────────────────────────────────────────────────────── */
.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 12.5px;
  font-weight: 500;
  color: var(--text-2);
  margin-bottom: 6px;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  font-size: 13.5px;
  color: var(--text);
  font-family: inherit;
  transition: border-color 0.12s, box-shadow 0.12s;
  outline: none;
  line-height: 1.5;
}

.form-control:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
}

.form-control::placeholder { color: var(--text-4); }

textarea.form-control { resize: vertical; min-height: 120px; }

select.form-control {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 32px;
  cursor: pointer;
}

.form-hint {
  font-size: 12px;
  color: var(--text-4);
  margin-top: 4px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* ── Channel Chips ──────────────────────────────────────────────────── */
.chip-group { display: flex; flex-wrap: wrap; gap: 6px; }

.chip {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 10px;
  border-radius: 99px;
  border: 1px solid var(--border2);
  background: var(--surface);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-3);
  cursor: pointer;
  transition: all 0.12s;
  user-select: none;
}

.chip:hover { border-color: var(--text-4); color: var(--text-2); }

.chip.selected {
  background: var(--accent-bg);
  border-color: var(--accent-bd);
  color: var(--accent);
}

.chip-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: currentColor;
}

/* ── Badge ──────────────────────────────────────────────────────────── */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 11.5px;
  font-weight: 500;
  font-family: 'Geist Mono', monospace;
}

.badge-blue   { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-bd); }
.badge-green  { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-bd); }
.badge-amber  { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-bd); }
.badge-red    { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-bd); }
.badge-purple { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple-bd); }
.badge-gray   { background: var(--surface2); color: var(--text-3); border: 1px solid var(--border); }

/* ── Table ──────────────────────────────────────────────────────────── */
.table-wrap { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13.5px;
}

thead th {
  text-align: left;
  padding: 10px 16px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-3);
  letter-spacing: 0.2px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}

tbody td {
  padding: 11px 16px;
  border-bottom: 1px solid var(--border);
  color: var(--text-2);
  vertical-align: middle;
}

tbody tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: var(--bg); }

/* ── Requirements List ──────────────────────────────────────────────── */
.req-list { display: flex; flex-direction: column; }

.req-row {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}

.req-row:last-child { border-bottom: none; }
.req-row:hover { background: var(--bg); }

.req-code {
  font-size: 11.5px;
  font-family: 'Geist Mono', monospace;
  color: var(--text-4);
  min-width: 58px;
  padding-top: 2px;
}

.req-body { flex: 1; min-width: 0; }

.req-title {
  font-size: 13.5px;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 3px;
}

.req-desc {
  font-size: 13px;
  color: var(--text-3);
  line-height: 1.55;
  margin-bottom: 8px;
}

.req-meta { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

/* Lifecycle stepper */
.lifecycle {
  display: flex;
  gap: 0;
  margin-top: 8px;
}

.lc-step {
  padding: 3px 10px;
  font-size: 11px;
  font-weight: 500;
  background: var(--surface2);
  color: var(--text-4);
  border: 1px solid var(--border);
  border-right: none;
  letter-spacing: 0.3px;
}

.lc-step:first-child { border-radius: 4px 0 0 4px; }
.lc-step:last-child { border-right: 1px solid var(--border); border-radius: 0 4px 4px 0; }

.lc-step.done { background: #dcfce7; color: var(--green); border-color: var(--green-bd); }
.lc-step.current { background: var(--accent-bg); color: var(--accent); border-color: var(--accent-bd); font-weight: 600; }

/* ── Stakeholders ───────────────────────────────────────────────────── */
.stakeholder-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  padding: 20px;
}

.stakeholder-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.s-avatar {
  width: 36px;
  height: 36px;
  background: var(--accent-bg);
  border: 1px solid var(--accent-bd);
  border-radius: var(--radius-sm);
  display: grid;
  place-items: center;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 10px;
  font-family: 'Geist Mono', monospace;
}

.s-name { font-size: 13.5px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.s-role { font-size: 12px; color: var(--text-3); margin-bottom: 10px; }

.influence-label {
  display: flex;
  justify-content: space-between;
  font-size: 11.5px;
  color: var(--text-4);
  margin-bottom: 4px;
}

.influence-bar-bg {
  height: 4px;
  background: var(--surface2);
  border-radius: 99px;
  overflow: hidden;
}

.influence-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 99px;
  transition: width 0.8s ease;
}

/* ── Risk Cards ─────────────────────────────────────────────────────── */
.risk-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  padding: 20px;
}

.risk-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
  border-top-width: 3px;
}

.risk-card.HIGH { border-top-color: var(--red); }
.risk-card.MEDIUM { border-top-color: var(--amber); }
.risk-card.LOW { border-top-color: var(--green); }

.risk-type {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-4);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-bottom: 5px;
}

.risk-title { font-size: 13.5px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.risk-desc { font-size: 13px; color: var(--text-3); line-height: 1.55; margin-bottom: 10px; }

.risk-mitigation {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 8px 10px;
  font-size: 12.5px;
  color: var(--text-3);
  line-height: 1.5;
}

.risk-mitigation strong {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-4);
  letter-spacing: 0.3px;
  text-transform: uppercase;
  margin-bottom: 3px;
}

/* ── Timeline ───────────────────────────────────────────────────────── */
.timeline { padding: 20px; }

.tl-item {
  display: flex;
  gap: 16px;
  padding-bottom: 20px;
  position: relative;
}

.tl-item:not(:last-child)::after {
  content: '';
  position: absolute;
  left: 11px;
  top: 28px;
  bottom: 0;
  width: 1px;
  background: var(--border);
}

.tl-dot {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  background: var(--surface);
  display: grid;
  place-items: center;
  flex-shrink: 0;
  z-index: 1;
}

.tl-dot.done { border-color: var(--green); background: var(--green-bg); }
.tl-dot.done::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--green); }

.tl-dot.active { border-color: var(--accent); background: var(--accent-bg); }
.tl-dot.active::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }

.tl-dot.pending::after { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--border2); }

.tl-content { flex: 1; padding-top: 2px; }

.tl-date {
  font-size: 11.5px;
  color: var(--text-4);
  font-family: 'Geist Mono', monospace;
  margin-bottom: 3px;
}

.tl-title { font-size: 13.5px; font-weight: 600; color: var(--text); margin-bottom: 3px; }
.tl-desc { font-size: 13px; color: var(--text-3); line-height: 1.55; }

/* ── Knowledge Graph ────────────────────────────────────────────────── */
.graph-canvas {
  background: var(--bg);
  border-radius: var(--radius-sm);
  width: 100%;
  height: 360px;
}

.graph-legend {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-3);
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 2px;
}

/* ── Alert / Scope Creep ────────────────────────────────────────────── */
.alert {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  margin-bottom: 12px;
  border: 1px solid;
}

.alert-warning {
  background: var(--amber-bg);
  border-color: var(--amber-bd);
}

.alert-error {
  background: var(--red-bg);
  border-color: var(--red-bd);
}

.alert-icon { flex-shrink: 0; margin-top: 1px; }

.alert-content {}

.alert-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.alert-desc { font-size: 13px; color: var(--text-3); line-height: 1.5; }

/* ── Loading ────────────────────────────────────────────────────────── */
.loading-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(248,249,250,0.85);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
}

.loading-overlay.active { display: flex; }

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

.loading-step {
  font-size: 13px;
  color: var(--text-3);
  animation: fadePulse 1.5s ease-in-out infinite;
}

@keyframes fadePulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

.loading-progress {
  width: 220px;
  height: 3px;
  background: var(--border);
  border-radius: 99px;
  overflow: hidden;
}

.loading-bar {
  height: 100%;
  background: var(--accent);
  border-radius: 99px;
  transition: width 0.6s ease;
}

/* ── Modal ──────────────────────────────────────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(2px);
  z-index: 500;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 480px;
  max-width: 90vw;
  padding: 24px;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.modal-title { font-size: 15px; font-weight: 600; color: var(--text); }

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

/* ── BRD Document ───────────────────────────────────────────────────── */
.brd-doc {
  max-width: 800px;
  margin: 0 auto;
}

.brd-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.brd-section-header {
  padding: 13px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.brd-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-2);
  letter-spacing: 0.1px;
}

.brd-section-num {
  width: 20px;
  height: 20px;
  background: var(--accent);
  color: white;
  border-radius: 4px;
  display: grid;
  place-items: center;
  font-size: 11px;
  font-weight: 700;
  margin-right: 10px;
  flex-shrink: 0;
}

.brd-section-body {
  padding: 16px 20px;
  font-size: 13.5px;
  color: var(--text-2);
  line-height: 1.7;
}

.brd-item {
  display: flex;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13.5px;
  color: var(--text-2);
}

.brd-item:last-child { border-bottom: none; }

.brd-item-num {
  font-family: 'Geist Mono', monospace;
  font-size: 12px;
  color: var(--text-4);
  min-width: 24px;
  padding-top: 1px;
}

.scope-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }

.scope-col { padding: 16px 20px; }
.scope-col:first-child { border-right: 1px solid var(--border); }

.scope-col-label {
  font-size: 11.5px;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.scope-col.in .scope-col-label { color: var(--green); }
.scope-col.out .scope-col-label { color: var(--text-4); }

.scope-item {
  display: flex;
  gap: 8px;
  font-size: 13px;
  color: var(--text-3);
  padding: 3px 0;
}

/* ── Empty state ────────────────────────────────────────────────────── */
.empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 24px;
  text-align: center;
  gap: 10px;
}

.empty-icon {
  width: 44px;
  height: 44px;
  background: var(--surface2);
  border-radius: var(--radius);
  display: grid;
  place-items: center;
  margin-bottom: 4px;
}

.empty-title { font-size: 14px; font-weight: 600; color: var(--text-2); }
.empty-desc { font-size: 13px; color: var(--text-4); max-width: 280px; line-height: 1.6; }

/* ── Generate Panel ─────────────────────────────────────────────────── */
.generate-panel {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
  align-items: start;
}

.generate-sidebar { display: flex; flex-direction: column; gap: 12px; }

/* ── Activity ───────────────────────────────────────────────────────── */
.activity-list { display: flex; flex-direction: column; }

.activity-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.activity-item:last-child { border-bottom: none; }

.activity-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
  margin-top: 5px;
  flex-shrink: 0;
}

.activity-text { color: var(--text-2); line-height: 1.5; flex: 1; }
.activity-time { font-size: 12px; color: var(--text-4); font-family: 'Geist Mono', monospace; white-space: nowrap; }

/* ── Responsive ─────────────────────────────────────────────────────── */
@media (max-width: 1024px) {
  .stat-grid { grid-template-columns: repeat(2, 1fr); }
  .generate-panel { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .sidebar { display: none; }
  .stat-grid { grid-template-columns: 1fr 1fr; }
  .form-row { grid-template-columns: 1fr; }
}

/* ── Divider ────────────────────────────────────────────────────────── */
.divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 20px 0 16px;
  font-size: 11.5px;
  font-weight: 500;
  color: var(--text-4);
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

.divider::before, .divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* ── Tooltip ────────────────────────────────────────────────────────── */
.tooltip-wrap { position: relative; display: inline-flex; }

.tooltip {
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: white;
  font-size: 11.5px;
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
}

.tooltip-wrap:hover .tooltip { opacity: 1; }

/* ── Animations ─────────────────────────────────────────────────────── */
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

.fade-in { animation: fadeIn 0.25s ease forwards; }

.stagger > * { opacity: 0; animation: fadeIn 0.25s ease forwards; }
.stagger > *:nth-child(1) { animation-delay: 0.04s; }
.stagger > *:nth-child(2) { animation-delay: 0.08s; }
.stagger > *:nth-child(3) { animation-delay: 0.12s; }
.stagger > *:nth-child(4) { animation-delay: 0.16s; }
.stagger > *:nth-child(5) { animation-delay: 0.20s; }
.stagger > *:nth-child(6) { animation-delay: 0.24s; }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-title">Generating BRD</div>
  <div class="loading-step" id="loadingStep">Initializing AI pipeline...</div>
  <div class="loading-progress">
    <div class="loading-bar" id="loadingBar" style="width:5%"></div>
  </div>
</div>

<!-- New Project Modal -->
<div class="modal-overlay" id="newProjectModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Create New Project</div>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newProjectModal')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Project Name *</label>
      <input id="newProjectName" class="form-control" placeholder="e.g. Customer Portal v2.0" />
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Industry *</label>
        <select id="newProjectIndustry" class="form-control">
          <option value="fintech">FinTech</option>
          <option value="healthcare">Healthcare</option>
          <option value="ecommerce">E-Commerce</option>
          <option value="saas">Enterprise SaaS</option>
          <option value="logistics">Logistics</option>
          <option value="edtech">EdTech</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select id="newProjectStatus" class="form-control">
          <option value="active">Active</option>
          <option value="archived">Archived</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="newProjectDesc" class="form-control" rows="3" placeholder="Brief description..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('newProjectModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <span class="logo-name">Cortex BRD</span>
      <span class="logo-badge">v1.0</span>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Navigation</div>
      <div class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard', this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
        <span class="count" id="navProjectCount">0</span>
      </div>
      <div class="nav-item" id="nav-generate" onclick="showPage('generate', this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        Generate BRD
      </div>
    </div>

    <div class="sidebar-section" style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 4px;">
      <div class="sidebar-label">Recent Projects</div>
    </div>
    <div class="sidebar-projects" id="sidebarProjects">
      <div style="font-size:12px; color:var(--text-4); padding:4px 10px;">No projects yet</div>
    </div>

    <div class="sidebar-footer">
      <div class="status-badge">
        <div class="status-dot"></div>
        AI Online
      </div>
      <span style="margin-left:auto; font-size:11px;">HackFest 2.0</span>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">

    <!-- Topbar -->
    <div class="topbar">
      <span class="topbar-title" id="topbarTitle">Dashboard</span>
      <span class="topbar-sep" id="topbarSep" style="display:none;">›</span>
      <span class="topbar-sub" id="topbarSub"></span>
      <div class="topbar-actions">
        <button class="btn btn-secondary btn-sm" onclick="showPage('generate', document.getElementById('nav-generate'))">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
          New BRD
        </button>
        <button class="btn btn-primary btn-sm" onclick="openModal('newProjectModal')">
          New Project
        </button>
      </div>
    </div>

    <!-- Tabs (shown for BRD view) -->
    <div class="tabs" id="brdTabs" style="display:none;">
      <div class="tab-btn active" onclick="switchBrdTab('document', this)">Document</div>
      <div class="tab-btn" onclick="switchBrdTab('requirements', this)">Requirements</div>
      <div class="tab-btn" onclick="switchBrdTab('stakeholders', this)">Stakeholders</div>
      <div class="tab-btn" onclick="switchBrdTab('risks', this)">Risks</div>
      <div class="tab-btn" onclick="switchBrdTab('timeline', this)">Timeline</div>
      <div class="tab-btn" onclick="switchBrdTab('graph', this)">Knowledge Graph</div>
    </div>

    <!-- Content -->
    <div class="content">

      <!-- Dashboard Page -->
      <div class="page active" id="page-dashboard">
        <div class="stat-grid stagger" id="dashStats">
          <div class="stat-card">
            <div class="stat-icon" style="background:#eff6ff;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </div>
            <div class="stat-label">Total Projects</div>
            <div class="stat-value" id="statProjects">0</div>
            <div class="stat-change">Across all teams</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:#f0fdf4;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div class="stat-label">BRDs Generated</div>
            <div class="stat-value" id="statBrds">0</div>
            <div class="stat-change">Versioned documents</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:#fffbeb;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            </div>
            <div class="stat-label">Requirements</div>
            <div class="stat-value" id="statReqs">0</div>
            <div class="stat-change">Extracted & classified</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:#fef2f2;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <div class="stat-label">High-Risk Flags</div>
            <div class="stat-value" id="statRisks">0</div>
            <div class="stat-change">Open risk items</div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 320px; gap:16px; align-items:start;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Projects</div>
              <button class="btn btn-secondary btn-sm" onclick="openModal('newProjectModal')">+ New Project</button>
            </div>
            <div id="projectsTable">
              <div class="empty">
                <div class="empty-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" color="var(--text-4)"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </div>
                <div class="empty-title">No projects yet</div>
                <div class="empty-desc">Create your first project and generate a BRD to get started.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Recent Activity</div>
            </div>
            <div class="card-body" id="activityList">
              <div style="font-size:13px; color:var(--text-4);">Activity will appear here as you work.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Generate BRD Page -->
      <div class="page" id="page-generate">
        <div class="generate-panel">
          <div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Input Configuration</div>
                <div style="font-size:12px; color:var(--text-4);">Powered by Claude AI</div>
              </div>
              <div class="card-body">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Project *</label>
                    <select id="genProject" class="form-control">
                      <option value="">— Select or create project —</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Industry</label>
                    <select id="genIndustry" class="form-control">
                      <option value="fintech">FinTech</option>
                      <option value="healthcare">Healthcare</option>
                      <option value="ecommerce">E-Commerce</option>
                      <option value="saas">Enterprise SaaS</option>
                      <option value="logistics">Logistics</option>
                      <option value="edtech">EdTech</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Data Channels</label>
                  <div class="chip-group" id="channelChips">
                    <div class="chip selected" data-ch="emails" onclick="toggleChip(this)"><span class="chip-dot"></span>Emails</div>
                    <div class="chip selected" data-ch="meetings" onclick="toggleChip(this)"><span class="chip-dot"></span>Meetings</div>
                    <div class="chip" data-ch="chats" onclick="toggleChip(this)"><span class="chip-dot"></span>Chat Logs</div>
                    <div class="chip" data-ch="docs" onclick="toggleChip(this)"><span class="chip-dot"></span>Documents</div>
                    <div class="chip" data-ch="tickets" onclick="toggleChip(this)"><span class="chip-dot"></span>Tickets</div>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Business Context / Raw Input *</label>
                  <textarea id="genContext" class="form-control" rows="10" style="min-height:200px;" placeholder="Paste emails, meeting notes, stakeholder discussions, or any business communications here.

Example:
From: Sarah (CEO) → To: Dev Team
Subject: New customer portal requirements

We need to build a unified customer portal by Q3. Key requirements:
- Single sign-on with Google/Microsoft
- Real-time analytics dashboard
- Mobile-responsive design
- Budget: $150k

Meeting Notes (March 15):
Team agreed on React + Node.js stack. PM flagged potential scope creep around the reporting module..."></textarea>
                  <div class="form-hint">The AI will filter noise, extract requirements, identify stakeholders, and map everything into a structured BRD.</div>
                </div>

                <div class="form-group">
                  <label class="form-label">BRD Depth</label>
                  <select id="genDepth" class="form-control">
                    <option value="executive">Executive Summary — High-level overview</option>
                    <option value="standard" selected>Standard BRD — Full document with traceability</option>
                    <option value="detailed">Detailed — Comprehensive with risk & lifecycle analysis</option>
                  </select>
                </div>

                <button class="btn btn-primary" id="generateBtn" onclick="generateBRD()" style="width:100%; justify-content:center; padding:10px;">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                  Generate BRD
                </button>
              </div>
            </div>
          </div>

          <!-- Generate Sidebar -->
          <div class="generate-sidebar">
            <div class="card">
              <div class="card-header"><div class="card-title">How it works</div></div>
              <div class="card-body" style="display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; gap:10px; font-size:13px; color:var(--text-3);">
                  <div style="width:20px; height:20px; background:var(--accent-bg); border:1px solid var(--accent-bd); border-radius:4px; display:grid; place-items:center; flex-shrink:0; font-size:11px; font-weight:700; color:var(--accent);">1</div>
                  <div><strong style="color:var(--text-2);">Ingest</strong> — Multi-channel data ingestion from emails, meetings, and documents</div>
                </div>
                <div style="display:flex; gap:10px; font-size:13px; color:var(--text-3);">
                  <div style="width:20px; height:20px; background:var(--accent-bg); border:1px solid var(--accent-bd); border-radius:4px; display:grid; place-items:center; flex-shrink:0; font-size:11px; font-weight:700; color:var(--accent);">2</div>
                  <div><strong style="color:var(--text-2);">Extract</strong> — NLP pipeline filters noise and mines requirements, decisions, timelines</div>
                </div>
                <div style="display:flex; gap:10px; font-size:13px; color:var(--text-3);">
                  <div style="width:20px; height:20px; background:var(--accent-bg); border:1px solid var(--accent-bd); border-radius:4px; display:grid; place-items:center; flex-shrink:0; font-size:11px; font-weight:700; color:var(--accent);">3</div>
                  <div><strong style="color:var(--text-2);">Map</strong> — Builds temporal knowledge graph with stakeholder influence scoring</div>
                </div>
                <div style="display:flex; gap:10px; font-size:13px; color:var(--text-3);">
                  <div style="width:20px; height:20px; background:var(--accent-bg); border:1px solid var(--accent-bd); border-radius:4px; display:grid; place-items:center; flex-shrink:0; font-size:11px; font-weight:700; color:var(--accent);">4</div>
                  <div><strong style="color:var(--text-2);">Generate</strong> — Produces structured, audit-ready BRD with full traceability</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><div class="card-title">Database Status</div></div>
              <div class="card-body" style="display:flex; flex-direction:column; gap:8px; font-size:13px; color:var(--text-3);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span>Backend</span>
                  <span id="dbStatus" class="badge badge-gray">In-Memory</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span>Projects stored</span>
                  <span id="dbProjects" style="font-family:'Geist Mono',monospace; color:var(--text-2);">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span>BRDs stored</span>
                  <span id="dbBrds" style="font-family:'Geist Mono',monospace; color:var(--text-2);">0</span>
                </div>
                <div style="margin-top:4px; padding:8px; background:var(--amber-bg); border:1px solid var(--amber-bd); border-radius:4px; font-size:12px; color:var(--amber);">
                  Run <code style="font-family:'Geist Mono',monospace;">node backend/server.js</code> to enable SQLite persistence
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BRD View Page -->
      <div class="page" id="page-brd">
        <!-- Tab panels -->
        <div class="tab-panel active" id="brd-document"></div>
        <div class="tab-panel" id="brd-requirements"></div>
        <div class="tab-panel" id="brd-stakeholders"></div>
        <div class="tab-panel" id="brd-risks"></div>
        <div class="tab-panel" id="brd-timeline"></div>
        <div class="tab-panel" id="brd-graph"></div>
      </div>

    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════════
   IN-MEMORY DATABASE (mirrors SQLite schema from backend)
═══════════════════════════════════════════════════════════════ */
const DB = {
  projects: JSON.parse(localStorage.getItem('cb_projects') || '[]'),
  brds: JSON.parse(localStorage.getItem('cb_brds') || '[]'),
  activity: JSON.parse(localStorage.getItem('cb_activity') || '[]'),

  save() {
    localStorage.setItem('cb_projects', JSON.stringify(this.projects));
    localStorage.setItem('cb_brds', JSON.stringify(this.brds));
    localStorage.setItem('cb_activity', JSON.stringify(this.activity));
  },

  log(projectId, action, detail) {
    this.activity.unshift({ id: uid(), projectId, action, detail, created_at: new Date().toISOString() });
    if (this.activity.length > 100) this.activity.length = 100;
    this.save();
  },

  addProject(p) {
    this.projects.unshift(p);
    this.save();
    this.log(p.id, 'PROJECT_CREATED', `Project "${p.name}" created`);
  },

  addBrd(brd) {
    this.brds.unshift(brd);
    this.save();
    this.log(brd.projectId, 'BRD_GENERATED', `BRD v${brd.version} saved for "${brd.projectTitle}"`);
  },

  getProjectBrds(projectId) {
    return this.brds.filter(b => b.projectId === projectId);
  },

  stats() {
    return {
      projects: this.projects.length,
      brds: this.brds.length,
      requirements: this.brds.reduce((s, b) => s + (b.requirements?.length || 0), 0),
      highRisks: this.brds.reduce((s, b) => s + (b.risks?.filter(r => r.severity === 'HIGH').length || 0), 0),
    };
  }
};

// ── Helpers ─────────────────────────────────────────────────────────────────
function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

// ── State ────────────────────────────────────────────────────────────────────
let currentBrd = null;
let activeChannels = ['emails', 'meetings'];

// ── Navigation ───────────────────────────────────────────────────────────────
function showPage(name, navEl, opts) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (navEl) navEl.classList.add('active');
  document.getElementById('brdTabs').style.display = 'none';

  const titles = { dashboard: 'Dashboard', generate: 'Generate BRD', brd: 'BRD Viewer' };
  document.getElementById('topbarTitle').textContent = titles[name] || name;
  document.getElementById('topbarSep').style.display = 'none';
  document.getElementById('topbarSub').textContent = '';

  if (name === 'dashboard') renderDashboard();
  if (name === 'generate') refreshProjectDropdown(opts && opts.projectId);
  if (name === 'brd' && currentBrd) {
    document.getElementById('brdTabs').style.display = 'flex';
  }
}

function switchBrdTab(name, el) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('brd-' + name).classList.add('active');
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Click backdrop to close
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// ── Chips ────────────────────────────────────────────────────────────────────
function toggleChip(el) {
  el.classList.toggle('selected');
  const ch = el.dataset.ch;
  if (el.classList.contains('selected')) activeChannels.push(ch);
  else activeChannels = activeChannels.filter(c => c !== ch);
}

// ── Projects ─────────────────────────────────────────────────────────────────
function createProject() {
  const name = document.getElementById('newProjectName').value.trim();
  const industry = document.getElementById('newProjectIndustry').value;
  const status = document.getElementById('newProjectStatus').value;
  const description = document.getElementById('newProjectDesc').value.trim();
  if (!name) return alert('Please enter a project name.');

  const p = { id: uid(), name, industry, status, description, created_at: new Date().toISOString(), brd_count: 0 };
  DB.addProject(p);
  closeModal('newProjectModal');
  document.getElementById('newProjectName').value = '';
  document.getElementById('newProjectDesc').value = '';
  document.getElementById('newProjectDesc') && (document.getElementById('newProjectDesc').value = '');
  renderDashboard();
  renderSidebar();

  // Auto-navigate to Generate BRD with this project pre-selected
  const genNav = document.getElementById('nav-generate');
  showPage('generate', genNav, { projectId: p.id });
  setTimeout(() => {
    document.getElementById('genProject').value = p.id;
    document.getElementById('genIndustry').value = p.industry || 'other';
    document.getElementById('genContext').focus();
    showToast(`Project "${p.name}" created — paste your context below and click Generate BRD`);
  }, 50);
}

function refreshProjectDropdown(preselectId) {
  const sel = document.getElementById('genProject');
  sel.innerHTML = '<option value="">— Select project —</option>' +
    DB.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  // Auto-select: use preselectId, or current value, or most recent project
  if (preselectId) {
    sel.value = preselectId;
  } else if (sel.value) {
    // keep current selection if still valid
  } else if (DB.projects.length === 1) {
    sel.value = DB.projects[0].id;
  }
}

// ── Dashboard ─────────────────────────────────────────────────────────────────
function renderDashboard() {
  const s = DB.stats();
  animCount('statProjects', s.projects);
  animCount('statBrds', s.brds);
  animCount('statReqs', s.requirements);
  animCount('statRisks', s.highRisks);
  document.getElementById('navProjectCount').textContent = s.projects;
  document.getElementById('dbProjects').textContent = s.projects;
  document.getElementById('dbBrds').textContent = s.brds;

  // Projects table
  const cont = document.getElementById('projectsTable');
  if (!DB.projects.length) {
    cont.innerHTML = `<div class="empty"><div class="empty-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" color="var(--text-4)"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div><div class="empty-title">No projects yet</div><div class="empty-desc">Create your first project to get started.</div></div>`;
    return;
  }

  const industryColors = { fintech: 'badge-blue', healthcare: 'badge-green', ecommerce: 'badge-purple', saas: 'badge-blue', logistics: 'badge-amber', edtech: 'badge-green', other: 'badge-gray' };

  cont.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Project Name</th><th>Industry</th><th>BRDs</th><th>Status</th><th>Created</th><th></th>
    </tr></thead>
    <tbody>
    ${DB.projects.map(p => {
      const brdCount = DB.getProjectBrds(p.id).length;
      const date = new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      return `<tr>
        <td style="font-weight:500; color:var(--text);">${p.name}</td>
        <td><span class="badge ${industryColors[p.industry] || 'badge-gray'}">${p.industry}</span></td>
        <td style="font-family:'Geist Mono',monospace;">${brdCount}</td>
        <td><span class="badge ${p.status === 'active' ? 'badge-green' : 'badge-gray'}">${p.status}</span></td>
        <td style="color:var(--text-4); font-size:12px;">${date}</td>
        <td style="display:flex; gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="openProjectBrds('${p.id}')">View →</button>
          <button class="btn btn-primary btn-sm" onclick="goGenerateForProject('${p.id}')">+ BRD</button>
        </td>
      </tr>`;
    }).join('')}
    </tbody>
  </table></div>`;

  // Activity
  const actCont = document.getElementById('activityList');
  if (!DB.activity.length) {
    actCont.innerHTML = `<div style="font-size:13px; color:var(--text-4);">No activity yet.</div>`;
    return;
  }
  actCont.innerHTML = `<div class="activity-list">
    ${DB.activity.slice(0, 8).map(a => {
      const time = new Date(a.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      return `<div class="activity-item"><div class="activity-dot"></div><div class="activity-text">${a.detail}</div><div class="activity-time">${time}</div></div>`;
    }).join('')}
  </div>`;
}

function renderSidebar() {
  const cont = document.getElementById('sidebarProjects');
  if (!DB.projects.length) {
    cont.innerHTML = `<div style="font-size:12px; color:var(--text-4); padding:4px 10px;">No projects yet</div>`;
    return;
  }
  cont.innerHTML = DB.projects.slice(0, 8).map(p => `
    <div class="project-item" onclick="openProjectBrds('${p.id}')">
      <div class="project-dot"></div>
      <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</span>
    </div>
  `).join('');
}

function goGenerateForProject(projectId) {
  const navItem = document.getElementById('nav-generate');
  showPage('generate', navItem, { projectId });
  setTimeout(() => {
    document.getElementById('genProject').value = projectId;
    const project = DB.projects.find(p => p.id === projectId);
    if (project) document.getElementById('genIndustry').value = project.industry || 'other';
    document.getElementById('genContext').focus();
  }, 50);
}

function openProjectBrds(projectId) {
  const project = DB.projects.find(p => p.id === projectId);
  const brds = DB.getProjectBrds(projectId);
  if (!brds.length) {
    alert(`No BRDs for "${project.name}" yet. Go to Generate BRD to create one.`);
    return;
  }
  loadBrd(brds[0]);
}

function animCount(id, target) {
  const el = document.getElementById(id);
  if (!el) return;
  let n = 0;
  const step = Math.max(1, Math.ceil(target / 20));
  const t = setInterval(() => { n = Math.min(n + step, target); el.textContent = n; if (n >= target) clearInterval(t); }, 40);
}

// ── JSON Repair ───────────────────────────────────────────────────────────────
// Handles truncated JSON by closing all open arrays/objects and fixing trailing commas
function repairTruncatedJSON(str) {
  try {
    // Remove any trailing incomplete property (e.g. "key": [1, 2, { "a":)
    // Walk backwards from the end, strip until we hit a complete value boundary
    let s = str.trimEnd();

    // Remove trailing comma if present
    s = s.replace(/,\s*$/, '');

    // Count open brackets and braces to know what to close
    const stack = [];
    let inString = false;
    let escape = false;

    for (let i = 0; i < s.length; i++) {
      const ch = s[i];
      if (escape) { escape = false; continue; }
      if (ch === '\\' && inString) { escape = true; continue; }
      if (ch === '"') { inString = !inString; continue; }
      if (inString) continue;
      if (ch === '{' || ch === '[') stack.push(ch);
      else if (ch === '}' || ch === ']') stack.pop();
    }

    // If we're mid-string, close the string first
    if (inString) s += '"';

    // Remove trailing incomplete key-value (e.g. , "someKey": )
    s = s.replace(/,\s*"[^"]*"\s*:\s*$/, '');
    s = s.replace(/,\s*"[^"]*"\s*$/, '');

    // Close all open structures in reverse
    for (let i = stack.length - 1; i >= 0; i--) {
      s += stack[i] === '{' ? '}' : ']';
    }

    return JSON.parse(s);
  } catch (e) {
    console.error('JSON repair failed:', e);
    return null;
  }
}

// ── Generate BRD ─────────────────────────────────────────────────────────────
async function generateBRD() {
  const ctx = document.getElementById('genContext').value.trim();
  const projectId = document.getElementById('genProject').value;
  const depth = document.getElementById('genDepth').value;
  const industry = document.getElementById('genIndustry').value;

  if (!ctx) { alert('Please provide business context.'); return; }
  if (!projectId) { alert('Please select or create a project first.'); return; }

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  showLoading(true);

  const project = DB.projects.find(p => p.id === projectId);
  const channels = activeChannels.join(', ');

  const steps = [
    [10, 'Ingesting multi-channel data...'],
    [25, 'Running noise filtering...'],
    [40, 'Extracting requirements via NLP...'],
    [55, 'Mining decisions & timelines...'],
    [68, 'Building temporal knowledge graph...'],
    [80, 'Analyzing stakeholder influence...'],
    [90, 'Detecting risks & scope signals...'],
    [96, 'Generating structured BRD...'],
  ];

  let si = 0;
  const stepTimer = setInterval(() => {
    if (si < steps.length) {
      setLoadingProgress(steps[si][0], steps[si][1]);
      si++;
    }
  }, 900);

  const prompt = `You are CORTEX-BRD, an enterprise AI Business Requirements Intelligence System. Analyze this business context and generate a comprehensive BRD.

Project: ${project.name}
Industry: ${industry}
Channels: ${channels}
Depth: ${depth}

Context:
${ctx}

Return ONLY valid JSON (no markdown fences) with this exact structure:
{
  "projectTitle": "string",
  "executiveSummary": "3-4 paragraph professional executive summary",
  "businessObjectives": ["objective 1", "objective 2", "objective 3", "objective 4"],
  "scope": {
    "in": ["in-scope item 1", "in-scope item 2", "in-scope item 3"],
    "out": ["out-of-scope item 1", "out-of-scope item 2"]
  },
  "requirements": [
    {
      "id": "BR-001",
      "title": "Short title",
      "description": "Detailed description of the requirement",
      "priority": "HIGH",
      "category": "Functional",
      "source": "email",
      "lifecycle": "approved"
    }
  ],
  "stakeholders": [
    { "name": "Full Name", "role": "Job Title", "influence": 90, "channel": "email" }
  ],
  "risks": [
    {
      "type": "Scope Creep",
      "title": "Risk title",
      "description": "Description of the risk",
      "severity": "HIGH",
      "mitigation": "How to mitigate this risk"
    }
  ],
  "timeline": [
    { "phase": "Phase name", "date": "Q1 2025", "description": "What happens in this phase", "status": "planned" }
  ],
  "successCriteria": ["criterion 1", "criterion 2", "criterion 3"],
  "assumptions": ["assumption 1", "assumption 2"],
  "traceScore": 88,
  "graphNodes": [
    { "id": "n1", "label": "short label", "type": "requirement", "x": 120, "y": 80 },
    { "id": "n2", "label": "short label", "type": "stakeholder", "x": 300, "y": 150 }
  ],
  "graphEdges": [
    { "from": "n1", "to": "n2", "label": "drives" }
  ]
}

Include at least 5 requirements, 4 stakeholders, 4 risks, 5 timeline milestones, and 6-8 graph nodes. Keep descriptions concise (1-2 sentences each). Spread graph nodes spatially across x:50-750, y:30-310.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 8000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      throw new Error(`API error ${response.status}: ${errData.error?.message || response.statusText}`);
    }

    const data = await response.json();

    if (!data.content || !data.content.length) {
      throw new Error('Empty response from API. Check your API key or network.');
    }

    // Check if response was cut off (stop_reason = max_tokens)
    if (data.stop_reason === 'max_tokens') {
      console.warn('Response hit token limit — attempting JSON repair...');
    }

    const rawText = data.content.map(i => i.text || '').join('');

    // Extract JSON from response
    let clean = rawText.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
    const jsonStart = clean.indexOf('{');
    if (jsonStart === -1) throw new Error('No valid JSON found in AI response.');
    clean = clean.slice(jsonStart);

    // Try parsing as-is first
    let brd;
    try {
      // Find the last valid closing brace
      const jsonEnd = clean.lastIndexOf('}');
      brd = JSON.parse(clean.slice(0, jsonEnd + 1));
    } catch (parseErr) {
      // JSON is truncated — repair it
      console.warn('Attempting JSON repair for truncated response...');
      brd = repairTruncatedJSON(clean);
      if (!brd) throw new Error('JSON response was truncated and could not be repaired. Try a shorter input or lower BRD depth.');
    }

    // Validate required fields, fill in defaults if missing
    brd.projectTitle = brd.projectTitle || project.name;
    brd.executiveSummary = brd.executiveSummary || 'No summary provided.';
    brd.businessObjectives = brd.businessObjectives || [];
    brd.scope = brd.scope || { in: [], out: [] };
    brd.requirements = brd.requirements || [];
    brd.stakeholders = brd.stakeholders || [];
    brd.risks = brd.risks || [];
    brd.timeline = brd.timeline || [];
    brd.successCriteria = brd.successCriteria || [];
    brd.assumptions = brd.assumptions || [];
    brd.traceScore = brd.traceScore || 75;
    brd.graphNodes = brd.graphNodes || [];
    brd.graphEdges = brd.graphEdges || [];

    clearInterval(stepTimer);
    setLoadingProgress(100, 'BRD ready!');

    setTimeout(() => {
      showLoading(false);
      btn.disabled = false;

      // Attach metadata
      brd.id = uid();
      brd.projectId = projectId;
      brd.projectName = project.name;
      brd.version = DB.getProjectBrds(projectId).length + 1;
      brd.depth = depth;
      brd.channels = channels;
      brd.rawContext = ctx;
      brd.created_at = new Date().toISOString();

      DB.addBrd(brd);
      renderSidebar();
      renderDashboard();
      loadBrd(brd);
      showToast(`BRD v${brd.version} generated — ${brd.requirements.length} requirements extracted`);
    }, 400);

  } catch (err) {
    clearInterval(stepTimer);
    showLoading(false);
    btn.disabled = false;
    console.error('BRD generation error:', err);
    showError('Generation failed: ' + err.message);
  }
}

function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('active', show);
}

function showToast(msg, type = 'success') {
  const existing = document.getElementById('toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.id = 'toast';
  t.style.cssText = `
    position:fixed; bottom:24px; right:24px; z-index:9999;
    background:${type === 'error' ? '#fef2f2' : '#f0fdf4'};
    border:1px solid ${type === 'error' ? '#fecaca' : '#bbf7d0'};
    color:${type === 'error' ? '#b91c1c' : '#15803d'};
    padding:12px 18px; border-radius:8px;
    font-size:13.5px; font-weight:500;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    max-width:360px; line-height:1.5;
    animation: slideUp 0.25s ease;
  `;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 4500);
}

function showError(msg) {
  showToast(msg, 'error');
  // Also show inline error in the generate panel
  const btn = document.getElementById('generateBtn');
  const existing = document.getElementById('genError');
  if (existing) existing.remove();
  const err = document.createElement('div');
  err.id = 'genError';
  err.style.cssText = `
    margin-top:10px; padding:10px 14px;
    background:#fef2f2; border:1px solid #fecaca;
    border-radius:5px; font-size:13px; color:#b91c1c; line-height:1.5;
  `;
  err.innerHTML = `<strong>Error:</strong> ${msg}<br><span style="font-size:12px; color:#9ca3af;">Check browser console (F12) for full details. Make sure you have a valid API connection.</span>`;
  btn.parentNode.insertBefore(err, btn.nextSibling);
  setTimeout(() => err.remove(), 8000);
}

function setLoadingProgress(pct, step) {
  document.getElementById('loadingBar').style.width = pct + '%';
  document.getElementById('loadingStep').textContent = step;
}

// ── BRD Renderer ─────────────────────────────────────────────────────────────
function loadBrd(brd) {
  currentBrd = brd;

  // Update topbar
  document.getElementById('topbarTitle').textContent = brd.projectName;
  document.getElementById('topbarSep').style.display = '';
  document.getElementById('topbarSub').textContent = brd.projectTitle;

  showPage('brd', null);
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('brdTabs').style.display = 'flex';

  // Reset tabs
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === 0));
  document.querySelectorAll('.tab-panel').forEach((p, i) => p.classList.toggle('active', i === 0));

  renderBrdDocument(brd);
  renderRequirements(brd);
  renderStakeholders(brd);
  renderRisks(brd);
  renderTimeline(brd);
  renderGraph(brd);
}

// ── Document Tab ──────────────────────────────────────────────────────────────
function renderBrdDocument(d) {
  const objectives = d.businessObjectives.map((o, i) => `
    <div class="brd-item">
      <div class="brd-item-num">0${i+1}</div>
      <div>${o}</div>
    </div>`).join('');

  const criteria = d.successCriteria.map(c => `
    <div style="display:flex; gap:8px; padding:5px 0; border-bottom:1px solid var(--border); font-size:13.5px; color:var(--text-2);">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5" style="flex-shrink:0; margin-top:2px;"><path d="M20 6L9 17l-5-5"/></svg>
      ${c}
    </div>`).join('');

  const assumptions = d.assumptions.map(a => `
    <div style="display:flex; gap:8px; padding:5px 0; border-bottom:1px solid var(--border); font-size:13.5px; color:var(--text-3);">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" style="flex-shrink:0; margin-top:2px;"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg>
      ${a}
    </div>`).join('');

  document.getElementById('brd-document').innerHTML = `
    <div class="brd-doc fade-in">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:20px; gap:16px; flex-wrap:wrap;">
        <div>
          <div style="font-size:12px; color:var(--text-4); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.5px;">Business Requirements Document</div>
          <h1 style="font-size:22px; font-weight:700; color:var(--text); letter-spacing:-0.5px; margin-bottom:6px;">${d.projectTitle}</h1>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <span class="badge badge-blue">v${d.version}</span>
            <span class="badge badge-gray">${d.depth}</span>
            <span class="badge badge-gray">${new Date(d.created_at).toLocaleDateString()}</span>
            <span class="badge badge-green">Trace Score: ${d.traceScore}%</span>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportBrd()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export
        </button>
      </div>

      <div class="brd-section">
        <div class="brd-section-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brd-section-num">1</div>
            <div class="brd-section-title">Executive Summary</div>
          </div>
        </div>
        <div class="brd-section-body">${d.executiveSummary.replace(/\n/g, '<br><br>')}</div>
      </div>

      <div class="brd-section">
        <div class="brd-section-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brd-section-num">2</div>
            <div class="brd-section-title">Business Objectives</div>
          </div>
        </div>
        <div class="brd-section-body" style="padding:0;">${objectives}</div>
      </div>

      <div class="brd-section">
        <div class="brd-section-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brd-section-num">3</div>
            <div class="brd-section-title">Project Scope</div>
          </div>
        </div>
        <div class="scope-grid">
          <div class="scope-col in">
            <div class="scope-col-label">✓ In Scope</div>
            ${d.scope.in.map(s => `<div class="scope-item"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5" style="flex-shrink:0; margin-top:2px;"><path d="M20 6L9 17l-5-5"/></svg>${s}</div>`).join('')}
          </div>
          <div class="scope-col out">
            <div class="scope-col-label">✗ Out of Scope</div>
            ${d.scope.out.map(s => `<div class="scope-item" style="color:var(--text-4);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0; margin-top:2px;"><path d="M18 6L6 18M6 6l12 12"/></svg>${s}</div>`).join('')}
          </div>
        </div>
      </div>

      <div class="brd-section">
        <div class="brd-section-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brd-section-num">4</div>
            <div class="brd-section-title">Success Criteria</div>
          </div>
        </div>
        <div class="brd-section-body" style="padding:12px 20px;">${criteria}</div>
      </div>

      ${d.assumptions.length ? `
      <div class="brd-section">
        <div class="brd-section-header">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="brd-section-num">5</div>
            <div class="brd-section-title">Assumptions & Constraints</div>
          </div>
        </div>
        <div class="brd-section-body" style="padding:12px 20px;">${assumptions}</div>
      </div>` : ''}
    </div>`;
}

// ── Requirements Tab ──────────────────────────────────────────────────────────
function renderRequirements(d) {
  const byP = { HIGH: [], MEDIUM: [], LOW: [] };
  d.requirements.forEach(r => (byP[r.priority] || byP.LOW).push(r));

  const lcStages = ['proposal', 'debate', 'approved', 'revision'];
  const prioColor = { HIGH: 'badge-red', MEDIUM: 'badge-amber', LOW: 'badge-gray' };
  const catColor = { Functional: 'badge-blue', 'Non-Functional': 'badge-purple', Business: 'badge-green' };

  let html = '';
  ['HIGH', 'MEDIUM', 'LOW'].forEach(p => {
    if (!byP[p].length) return;
    html += `<div class="divider">${p} Priority — ${byP[p].length} requirement${byP[p].length > 1 ? 's' : ''}</div>
    <div class="card" style="margin-bottom:16px;">
      <div class="req-list">
        ${byP[p].map(r => {
          const lc = (r.lifecycle || 'proposal').toLowerCase();
          const ci = lcStages.indexOf(lc);
          const lcHtml = lcStages.map((s, i) => `<div class="lc-step ${i < ci ? 'done' : ''} ${i === ci ? 'current' : ''}">${s.charAt(0).toUpperCase() + s.slice(1)}</div>`).join('');
          return `<div class="req-row">
            <div class="req-code">${r.id}</div>
            <div class="req-body">
              <div class="req-title">${r.title}</div>
              <div class="lifecycle">${lcHtml}</div>
              <div class="req-desc" style="margin-top:8px;">${r.description}</div>
              <div class="req-meta">
                <span class="badge ${prioColor[r.priority]}">${r.priority}</span>
                <span class="badge ${catColor[r.category] || 'badge-gray'}">${r.category}</span>
                <span class="badge badge-gray">Source: ${r.source || 'multi'}</span>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  });

  document.getElementById('brd-requirements').innerHTML = `<div class="fade-in">${html}</div>`;
}

// ── Stakeholders Tab ──────────────────────────────────────────────────────────
function renderStakeholders(d) {
  document.getElementById('brd-stakeholders').innerHTML = `
    <div class="fade-in">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Stakeholder Network — ${d.stakeholders.length} Identified</div>
          <div style="font-size:12px; color:var(--text-4);">Influence scores based on communication patterns</div>
        </div>
        <div class="stakeholder-grid">
          ${d.stakeholders.map(s => `
            <div class="stakeholder-card">
              <div class="s-avatar">${(s.name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase()}</div>
              <div class="s-name">${s.name}</div>
              <div class="s-role">${s.role}</div>
              <div class="influence-label">
                <span>Influence Score</span>
                <span style="font-family:'Geist Mono',monospace;">${s.influence}%</span>
              </div>
              <div class="influence-bar-bg">
                <div class="influence-bar-fill" style="width:${s.influence}%"></div>
              </div>
              <div style="margin-top:8px;">
                <span class="badge badge-gray" style="font-size:11px;">${s.channel || 'meeting'}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>`;
}

// ── Risks Tab ─────────────────────────────────────────────────────────────────
function renderRisks(d) {
  const scopeCreeps = d.risks.filter(r => r.type === 'Scope Creep' && r.severity === 'HIGH');
  const alerts = scopeCreeps.map(r => `
    <div class="alert alert-warning">
      <div class="alert-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      </div>
      <div class="alert-content">
        <div class="alert-title">Scope Creep Detected — ${r.title}</div>
        <div class="alert-desc">${r.description}</div>
      </div>
    </div>`).join('');

  document.getElementById('brd-risks').innerHTML = `
    <div class="fade-in">
      ${alerts}
      <div class="card">
        <div class="card-header">
          <div class="card-title">Risk Registry</div>
          <div style="display:flex; gap:6px;">
            <span class="badge badge-red">High: ${d.risks.filter(r=>r.severity==='HIGH').length}</span>
            <span class="badge badge-amber">Medium: ${d.risks.filter(r=>r.severity==='MEDIUM').length}</span>
            <span class="badge badge-gray">Low: ${d.risks.filter(r=>r.severity==='LOW').length}</span>
          </div>
        </div>
        <div class="risk-grid">
          ${d.risks.map(r => `
            <div class="risk-card ${r.severity}">
              <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <div class="risk-type">${r.type}</div>
                <span class="badge ${r.severity==='HIGH'?'badge-red':r.severity==='MEDIUM'?'badge-amber':'badge-green'}">${r.severity}</span>
              </div>
              <div class="risk-title">${r.title}</div>
              <div class="risk-desc">${r.description}</div>
              <div class="risk-mitigation">
                <strong>Mitigation Strategy</strong>
                ${r.mitigation}
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>`;
}

// ── Timeline Tab ──────────────────────────────────────────────────────────────
function renderTimeline(d) {
  const dotClass = { done: 'done', 'in-progress': 'active', planned: 'pending', delayed: 'pending' };
  document.getElementById('brd-timeline').innerHTML = `
    <div class="fade-in">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Project Timeline & Milestones</div>
          <div style="font-size:12px; color:var(--text-4);">${d.timeline.length} milestones</div>
        </div>
        <div class="timeline">
          ${d.timeline.map(t => `
            <div class="tl-item">
              <div class="tl-dot ${dotClass[t.status] || 'pending'}"></div>
              <div class="tl-content">
                <div class="tl-date">${t.date}</div>
                <div class="tl-title">${t.phase}</div>
                <div class="tl-desc">${t.description}</div>
                <div style="margin-top:6px;">
                  <span class="badge ${t.status==='done'?'badge-green':t.status==='in-progress'?'badge-blue':t.status==='delayed'?'badge-red':'badge-gray'}">${t.status||'planned'}</span>
                </div>
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>`;
}

// ── Knowledge Graph Tab ───────────────────────────────────────────────────────
function renderGraph(d) {
  const nodes = d.graphNodes || [];
  const edges = d.graphEdges || [];

  // Auto-position if needed
  nodes.forEach((n, i) => {
    if (!n.x || !n.y) {
      const angle = (i / nodes.length) * Math.PI * 2;
      n.x = 400 + Math.cos(angle) * 250;
      n.y = 180 + Math.sin(angle) * 130;
    }
  });

  const typeConfig = {
    requirement: { bg: '#eff6ff', border: '#bfdbfe', text: '#1d4ed8', label: 'Requirement' },
    stakeholder: { bg: '#f0fdf4', border: '#bbf7d0', text: '#15803d', label: 'Stakeholder' },
    decision: { bg: '#fffbeb', border: '#fde68a', text: '#b45309', label: 'Decision' },
    risk: { bg: '#fef2f2', border: '#fecaca', text: '#b91c1c', label: 'Risk' },
  };

  const svgContent = `
    <defs>
      <marker id="arrowBlue" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
        <path d="M0,0 L6,3 L0,6 Z" fill="#94a3b8"/>
      </marker>
    </defs>
    ${edges.map(e => {
      const f = nodes.find(n => n.id === e.from);
      const t = nodes.find(n => n.id === e.to);
      if (!f || !t) return '';
      const mx = (f.x + t.x) / 2;
      const my = (f.y + t.y) / 2;
      return `
        <line x1="${f.x}" y1="${f.y}" x2="${t.x}" y2="${t.y}" stroke="#e2e8f0" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
        ${e.label ? `<text x="${mx}" y="${my - 4}" text-anchor="middle" fill="#94a3b8" font-family="'Geist Mono', monospace" font-size="8">${e.label}</text>` : ''}
      `;
    }).join('')}
    ${nodes.map(n => {
      const c = typeConfig[n.type] || typeConfig.requirement;
      const lbl = (n.label || '').substring(0, 16);
      const w = Math.max(80, lbl.length * 6 + 20);
      return `
        <g>
          <rect x="${n.x - w/2}" y="${n.y - 14}" width="${w}" height="28" rx="5"
            fill="${c.bg}" stroke="${c.border}" stroke-width="1.5"/>
          <text x="${n.x}" y="${n.y + 5}" text-anchor="middle" fill="${c.text}"
            font-family="'Geist', sans-serif" font-size="9.5" font-weight="500">${lbl}</text>
        </g>`;
    }).join('')}
  `;

  const legendItems = Object.entries(typeConfig).map(([k, v]) => `
    <div class="legend-item">
      <div class="legend-dot" style="background:${v.bg}; border:1.5px solid ${v.border};"></div>
      ${v.label}
    </div>`).join('');

  document.getElementById('brd-graph').innerHTML = `
    <div class="fade-in">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Temporal Business Knowledge Graph</div>
          <div style="font-size:12px; color:var(--text-4);">${nodes.length} nodes · ${edges.length} relationships</div>
        </div>
        <div class="card-body">
          <svg class="graph-canvas" viewBox="0 0 800 360" xmlns="http://www.w3.org/2000/svg" style="border:1px solid var(--border);">
            ${svgContent}
          </svg>
          <div class="graph-legend">${legendItems}</div>
        </div>
      </div>
    </div>`;
}

// ── Export ────────────────────────────────────────────────────────────────────
function exportBrd() {
  if (!currentBrd) return;
  const d = currentBrd;
  let txt = `BUSINESS REQUIREMENTS DOCUMENT\n${d.projectTitle}\n${'═'.repeat(60)}\n\n`;
  txt += `Version: ${d.version}  |  Generated: ${new Date(d.created_at).toLocaleDateString()}  |  Trace Score: ${d.traceScore}%\n\n`;
  txt += `EXECUTIVE SUMMARY\n${'─'.repeat(40)}\n${d.executiveSummary}\n\n`;
  txt += `BUSINESS OBJECTIVES\n${'─'.repeat(40)}\n${d.businessObjectives.map((o,i)=>`${i+1}. ${o}`).join('\n')}\n\n`;
  txt += `SCOPE IN:  ${d.scope.in.join(', ')}\nSCOPE OUT: ${d.scope.out.join(', ')}\n\n`;
  txt += `REQUIREMENTS (${d.requirements.length})\n${'─'.repeat(40)}\n`;
  d.requirements.forEach(r => { txt += `[${r.id}] ${r.title} — ${r.priority}\n  ${r.description}\n  Status: ${r.lifecycle}\n\n`; });
  txt += `RISKS (${d.risks.length})\n${'─'.repeat(40)}\n`;
  d.risks.forEach(r => { txt += `[${r.severity}] ${r.title} (${r.type})\n  ${r.description}\n  Mitigation: ${r.mitigation}\n\n`; });
  txt += `SUCCESS CRITERIA\n${'─'.repeat(40)}\n${d.successCriteria.map((c,i)=>`${i+1}. ${c}`).join('\n')}\n\n`;
  txt += `\n── Generated by CORTEX-BRD · HackFest 2.0 · Team Metallica ──`;

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([txt], { type: 'text/plain' }));
  a.download = `${d.projectTitle.replace(/\s+/g,'_')}_BRD_v${d.version}.txt`;
  a.click();
}

// ── Init ──────────────────────────────────────────────────────────────────────
renderDashboard();
renderSidebar();
</script>
</body>
</html>
